<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.idata365.col.mapper.DriveDataMainMapper">
    <resultMap id="driveDataMainMap" type="com.idata365.col.entity.DriveDataMain" >
        <id column="id" property="id" jdbcType="BIGINT" />
        <result column="userId" property="userId" jdbcType="BIGINT" />
        <result column="habitId" property="habitId" jdbcType="BIGINT" />
          <result column="taskFlag" property="taskFlag" jdbcType="BIGINT" />
	   
	   <result column="driveTimes" property="driveTimes" jdbcType="BIGINT" />
	    <result column="driveDistance" property="driveDistance" jdbcType="DECIMAL" />
	      <result column="avgSpeed" property="avgSpeed" jdbcType="DECIMAL" />
	      <result column="maxSpeed" property="maxSpeed" jdbcType="DECIMAL" />
        <result column="createTime" property="createTime" jdbcType="DATE" />
       <result column="validStatus" property="validStatus" jdbcType="SMALLINT" />
       <result column="isPost" property="isPost" jdbcType="SMALLINT" />
       <result column="postTime" property="postTime" jdbcType="DATE" />
    </resultMap>

    <insert id="insertDataLog" useGeneratedKeys="true" keyProperty="id" parameterType="com.idata365.col.entity.DriveDataMain" >
       INSERT ignore INTO 
            driveDataMain
            (userId,habitId,driveStartTime,driveEndTime,driveTimes,driveDistance,
            maxSpeed,createTime,validStatus,avgSpeed,
            speedUpTimes,brakeTimes,turnTimes,speed120To129Times,speed130To139Times,
            speed140To149Times,speed150To159Times,speed160UpTimes) 
        VALUES
            (#{userId}, #{habitId}, #{driveStartTime}, #{driveEndTime}, 
            #{driveTimes},#{driveDistance}, 
            #{maxSpeed},now(), #{validStatus}, #{avgSpeed},
             #{speedUpTimes} #{brakeTimes} #{turnTimes} #{speed120To129Times},
              #{speed130To139Times} #{speed140To149Times} #{speed150To159Times} #{speed160UpTimes})
    </insert>




	
	<!-- 锁定任务 -->
    <update id="lockSendDriveTask" parameterType="com.idata365.col.entity.DriveDataMain" >
       UPDATE 
            driveDataMain 
       SET 
        isPost=-1,taskFlag=#{taskFlag},postTime=now()
       WHERE 
            isPost = 0  and taskFlag=0 and validStatus=1
    </update>
    
	<!-- 获取任务 -->
	 <select id="getSendDriveTask"  resultMap="driveDataMainMap" parameterType="com.idata365.col.entity.DriveDataMain">
		SELECT *  from driveDataMain where isPost=0 and taskFlag=#{taskFlag}
	 </select>
	
	 <!-- 更新任务 -->
     <update id="updateSuccSendDriveTask" parameterType="com.idata365.col.entity.DriveDataMain" >
       UPDATE 
           driveDataMain 
       SET 
           isPost=#{isPost},postTime=now()
       WHERE 
              taskFlag=#{taskFlag}
     </update>
    <update id="updateFailSendDriveTask" parameterType="com.idata365.col.entity.DriveDataMain" >
       UPDATE 
           driveDataMain 
       SET 
           isPost=#{isPost},taskFlag=0,postTime=now(),failTimes=failTimes+1
       WHERE 
              taskFlag=#{taskFlag}
     </update>

<!-- 清除锁定的记录 -->
    <update id="clearLockTask" parameterType="java.lang.Long" >
       UPDATE 
           driveDataMain 
       SET 
           isPost=0,failTimes=failTimes+1
       WHERE 
              isPost=-1 and taskFlag<![CDATA[<]]>${compareTimes}
     </update>
 
 
 	<!-- 获取行程 -->
	 <select id="getDriveDataMainByUH"  resultMap="driveDataMainMap" parameterType="com.idata365.col.entity.DriveDataMain">
		SELECT *  from driveDataMain where  userId=#{userId} and habitId=#{habitId}
	 </select>
 
</mapper>